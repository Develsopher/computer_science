
# 장치 컨트롤러와 장치 드라이버
#### 입출력장치
- 컴퓨터 외부에 연결되어 있는 장치
## 1. 장치 컨트롤러

### 입출력장치가 다루기 어려운이유
#### 1. 종류가 너무 많음
#### 2. 규격화하기 어려움
![](https://i.imgur.com/EYdUt7D.png)

#### 3. CPU와 메모리와 다르게 데이터 전송률이 낮음
- 전송률 : 데이터를 얼마나 빨리 교환할 수 있는지를 나타내는 지표

![](https://i.imgur.com/7La15k5.png)


### 장치 컨트롤러
- 위와 같은 문제로 컴퓨터에 직접 연결되지 않고 **장치 컨트롤러라는 하드웨어**로 연결됨
#### 역할
1. CPU와 입출력 장치 간의 통신 중개
2. 오류 검출
3. 데이터 버퍼링

![](https://i.imgur.com/xcdp6uC.png)

> **데이터 버퍼링** : 전송률이 높은 장치와 낮은 장치 사이에 주고받는 데이터를 버퍼에 저장해 전송률을 맞추는 방법
> ---> **버퍼에 데이터를 조금씩 모았다가 한꺼번에 내보내거나 데이터를 한번에 받아 조금씩 내보내는 방법**

![](https://i.imgur.com/fucDmNG.png)

### 장치 컨트롤러의 내부 구조
![](https://i.imgur.com/oVJzBnS.png)


#### 데이터 레지스터
- CPU와 입출력 장치 사이에 주고 받을 데이터가 담기는 레지스토
- 버퍼 역할을 담당
#### 상태 레지스터
- 입출력 장치의 작업 상태를 저장
- 작업 준비, 완료, 오류 같은 상태
#### 제어 레지스터
- 입출력 장치가 수행할 내용에 대한 제어 정보와 명령을 저장

## 2. 장치 드라이버
#### 정의
- 장치 컨트롤러의 동작을 감지하고 제어
- 컴퓨터 내부와 정보를 주고받을 수 있게 하는 프로그램
- 컨트롤러는 몸, 드라이버는 지식이라고 생각하면됨
![](https://i.imgur.com/3tp2cCr.png)

#### 장치 드라이버 인식 오류
- 장치 드라이버가 설치되지 않으면 해당 입출력 장치를 사용할 수 없음

![](https://i.imgur.com/zSVDN0P.png)


# 다양한 입출력 방법

## 프로그램 입출력
- 프로그램 속 명령어로 입 출력 장치를 제어하는 방법

### 1. 메모리에 저장된 정보를 하드 디스크의 백업
- 하드 디스크에 새로운 정보를 씀

![](https://i.imgur.com/W6vAVqO.png)


### 2. 컨트롤러가 하드디스크 상태 확인
- 하드디스크가 준비된 상태면 상태 레지스터에 준비되었다고 표시됨
![](https://i.imgur.com/rPANrm4.png)

### 3. 준비 확인 및 작성 
1. cpu가 상태 레지스터를 주기적으로 읽으며 하드디스크의 준비 여부를 확인
2. 하드디스크가 준비된 것을 CPU가 알게 되면 백업할 메모리의 정보를 데이터 레지스터에 씀
> 아직 완료되지 않았다면 1번부터 반복 후 쓰기가 완료되면 작업 종료

![](https://i.imgur.com/85H2GOz.png)


## 입출력 방식
- 입출력 작업은 CPU가 장치 컨트롤러의 레지스터 값을 읽고 씀으로 이루어짐
- CPU가 입출력장치들의 주소를 아는 방법은 다음과 같음

### 1. 메모리 맵 입출력
- **메모리에 접근하기 위한** **주소 공간**과 **입출력 장치에 접근하기 위한 주소 공간**으로 간주하는 방법
![](https://i.imgur.com/LP8WYe1.png)

#### EX
516번지 : 프런터 컨트롤러의 데이터 레지스터
517번지 : 프런터 컨트롤러의 상태 레지스터
518번지 : 하드 디스크 컨트롤러의 데이터 레지스터
519번지 : 하드 디스크 컨트롤러의 상태 레지스터

> CPU가 내릴 수 있는 명령어
> 1. 517번지를 읽어들이는 명령어로 키보드 상태를 읽을 수 있음
> 2. 518번지에 a를 써라라는 명령어로 하드 디스크 컨트롤러의 데이터 레지스터로 데이터를 보낼 수 있음
### 2. 고립형 입출력
- 메모리를 위한 주소 공간과 입출력 장치를 위한 주소 공간을 분리하는 방법

![](https://i.imgur.com/3qiGsiq.png)

- 입출력 전용 명령어를 사용
![](https://i.imgur.com/YG9UJNC.png)

![](https://i.imgur.com/u9rVuco.png)

### 3. 인터럽트 기반 입출력
- 인터럽트 기반으로 하는 입출력
![](https://i.imgur.com/LrjULQM.png)

#### 인터럽트
- **CPU가 입출력 장치에 처리할 내용**을 명령 
- -->**입출력 장치가 명령어를 수행하는 동안 CPU는 다른 일**을 할 수 있음

- **입출력 장치가 인터럽트를 보냄** 
- --> CPU는 하던 일을 멈춤
- -->해당 **인터럽트를 처리하는 프로그램인 인터럽트 서비스 루틴을 실행**
- -->다시 하던 일로 되돌아옴

- 입출력 장치가 아닌 **장치 컨트롤러**에 의해 발생함 

- CPU는 장치 컨트롤러에 입출력 작업을 명령하고 다른 일을 수행할 수 있음

> **폴링** : 입출력 장치의 상태는 어떤지, 처리할 데이터가 있는지 주기적으로 확인하는 방식


#### 입출력 장치가 많을 경우
![](https://i.imgur.com/FEAjYxR.png)

##### 1. 순서대로 처리하는 방법
![](https://i.imgur.com/7Pg3rqP.png)

+ 플래그 레지스터 속 인터럽트 비트를 비활성화한 채 인터럽트를 처리하는 경우
+ 하지만 현실적으로 순서대로 해결할 수는 없음

##### 2. 우선순위를 적용한 인터럽트
- NMI가 발생한 경우, 플래그 레지스터 속 인터럽트 비트를 활성화한 채 인터럽트를 처리하는 경우 발생

![](https://i.imgur.com/XgUhre1.png)

#### PIC(Programmable Interrupt Controller)
- 여러 장치 컨트롤러에 연결되어있음
- 장치 컨트롤러에 보낸 하드웨어 인터럽트 요청들의 우선순위를 판별
- CPU에 지금 처리해야 할 하드웨어 인터럽트가 무엇인지 알려주는 장치
![](https://i.imgur.com/Ad6VV7J.png)

##### 처리과정
1. **PIC**가 **장치 컨트롤러에 인터럽트 신호**를 받아들임
2. **인터럽트 우선순위**를 판단한 뒤 CPU에 처리해야 할 **인터럽트 요청 신호**를 보냄
3. CPU는 **PIC에 인터럽트 확인 신호**를 보냄
4. **PIC**는 **데이터 버스를 통해 CPU에 인터럽트 벡터**를 보냄
5. CPU는 **인터럽트 백터를 통해 인터럽트 요청의 주체**를 확인 후 **해당 장치의 인터럽트 서비스 루틴** 실행

#### DMA 입출력
- 입출력장치와 메모리 간의 데이터 이동은 CPU가 주도
- 이동하는 데이터도 반드시 CPU를 거침

- 메모리에 저장하는 경우
1. 장치 컨트롤러에 입출력장치 데이터를 하나씩 읽어 레지스터에 적재
2. 적재한 데이터를 메모리에 저장
![](https://i.imgur.com/9Xi2WtC.png)

- 메모리의 데이터를 입출력에 저장하는 경우
1. 메모리에 데이터를 하나씩 읽어 레지스터에 적재
2. 적재한 데이터를 하나씩 입출력장치에 내보냄
![](https://i.imgur.com/hkRwiSA.png)


##### DMA
- CPU를 무조건 거쳐야한다면 CPU의 성능 저하가 일어날수있음
- **DMA** : 입출력장치와 메모리가 CPU를 거치지 않고 상호작용할 수 있는 입출력 장치

- CPU를 거치지 않고 입출력 장치가 메모리에 직접적으로 접근하는 기능
![](https://i.imgur.com/4kMrJwK.png)

##### DMA과정

1. CPU가 DMA에게 입출력장치의 주소,연산 또는 읽거나 쓸 메모리의 주소와 같은 정보로 입출력 작업을 명령
2. ![](https://i.imgur.com/CGINDzs.png)

3. DMA는 CPU 대신 장치 컨트롤러와 상호작용하며 입출력 작업을 수행
4. ![](https://i.imgur.com/AB9vUSA.png)

5. 입출력 작업이 끝나면 DMA는 CPU에게 인터럽트를 걸어 작업이 끝났음을 알림
6. ![](https://i.imgur.com/550zRzA.png)

> DMA컨트롤러는 시스템 버스로 메모리에 직접 접근이 가능
> 하지만 시스템 버스는 공용 자원이므로 CPU가 사용할 때는 사용하면 안됨
> ![](https://i.imgur.com/MOkFbaa.png)


#### 입출력 버스
##### 문제점

- 장치 컨트롤러가 시스템 버스를 사용하면 메모리에 접근할 때마다 시스템 버스를 두 번 사용해야 하는 단점이 있음
- 그래서 CPU가 시스템 버스를 이용하지 못할수있음 
![](https://i.imgur.com/KbckDdo.png)

##### 정의
- DMA와 장치 컨트롤러들끼리 연결해놓은 버스


![](https://i.imgur.com/Kj1hfzn.png)


##### PCI 버스
##### PCI Express 버스 (PCIe)

![](https://i.imgur.com/z5NVgPr.png)

 



#### 발전한 DMA 입출력 채널
##### 입출력 프로세서(입출력 채널)
- 메모리에 직접 접근, 입출력 명령어 인출,해석,실행까지 되는 입출력 전용 CPU

![](https://i.imgur.com/Pxz1Z1i.png)
